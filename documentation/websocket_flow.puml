@startuml WebSocket Flow

skinparam backgroundColor white
skinparam handwritten false

actor Client
participant "Frontend" as FE
participant "WebSocket Server" as WS
participant "ClerkChannelInterceptor" as Interceptor
participant "MessageService" as Service
database "Database" as DB

== WebSocket Connection ==
Client -> FE: Connect to WebSocket
FE -> WS: CONNECT + Bearer Token
activate WS
WS -> Interceptor: Validate Connection
activate Interceptor
Interceptor -> DB: Verify User
DB --> Interceptor: User Details
Interceptor -> Interceptor: Set Security Context
Interceptor --> WS: Connection Authorized
deactivate Interceptor
WS --> FE: Connection Established
deactivate WS

== Channel Subscription ==
Client -> FE: Subscribe to Channel
FE -> WS: SUBSCRIBE /topic/channels/{channelId}
activate WS
WS -> Interceptor: Validate Subscription
activate Interceptor
Interceptor -> DB: Check Channel Access
DB --> Interceptor: Access Granted
Interceptor --> WS: Subscription Authorized
deactivate Interceptor
WS --> FE: Subscription Confirmed
deactivate WS

== Message Flow ==
Client -> FE: Send Message
FE -> WS: SEND /app/channels/{channelId}/messages
activate WS
WS -> Service: Process Message
activate Service
Service -> DB: Save Message
DB --> Service: Message Saved
Service -> WS: Broadcast Message
WS -> FE: MESSAGE /topic/channels/{channelId}
deactivate Service
WS --> Client: Message Delivered
deactivate WS

== Typing Indicator ==
Client -> FE: Start Typing
FE -> WS: SEND /app/channels/{channelId}/typing
activate WS
WS -> Service: Process Typing Event
Service -> WS: Broadcast Typing Event
WS -> FE: MESSAGE /topic/channels/{channelId}/typing
WS --> Client: Typing Event Delivered
deactivate WS

@enduml 